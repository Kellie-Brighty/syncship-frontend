rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: check if the user is authenticated
    function isAuth() {
      return request.auth != null;
    }

    // Helper: check if the user owns the document
    function isOwner(uid) {
      return isAuth() && request.auth.uid == uid;
    }

    // Users collection — users can only read/write their own doc
    match /users/{userId} {
      allow read, update: if isOwner(userId);
      allow create: if isAuth() && request.auth.uid == userId;
      allow delete: if false;
    }

    // Settings collection — users can manage their personal settings (e.g., GitHub tokens)
    match /settings/{userId} {
      allow read, write: if isOwner(userId);
    }

    // Sites collection — only the owner can CRUD their sites
    match /sites/{siteId} {
      allow read: if isAuth() && resource.data.ownerId == request.auth.uid;
      allow create: if isAuth() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isAuth() && resource.data.ownerId == request.auth.uid;
      allow delete: if isAuth() && resource.data.ownerId == request.auth.uid;
    }

    // Deployments — owner can create and read. Owner can ONLY update status to 'canceled'
    match /deployments/{deployId} {
      allow read: if isAuth() && resource.data.ownerId == request.auth.uid;
      allow create: if isAuth() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isAuth() && resource.data.ownerId == request.auth.uid 
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'completedAt'])
                    && request.resource.data.status == 'canceled';
      allow delete: if false;
    }

    // Server stats — any authenticated user can read; daemon writes via admin SDK
    match /serverStats/{serverId} {
      allow read: if isAuth();
      allow write: if false; // Only daemon (admin SDK) can write
    }
    
    // Daemon status and commands
    match /daemon/{docId} {
      allow read: if isAuth();
      allow write: if isAuth() && docId == 'commands';
    }

    // Deny everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
